language: node_js
node_js:
  - "7"
notifications:
  email: false
  webhooks:
    urls:
    - https://server.tyratox.ch/webhooks/travis/
    on_success: always
    on_failure: always
    on_start: never
    on_cancel: always
    on_error: always
branches:
  except:
    - /^build-[0-9A-z\-]*/
install:
  - yarn install
before_script:
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" == "release" ]; then
      echo "{\"API_URL:\":\"https://api.booki.me\", \"API_VERSION:\":\"1\", \"CLIENT_ID:\":\"2\", \"REDIRECT_URI:\":\"https://booki.me/oauth-callback\"}" > config.json;
    fi
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" == "master" ]; then
      echo "{\"API_URL:\":\"https://beta-api.booki.me\", \"API_VERSION:\":\"1\", \"CLIENT_ID:\":\"2\", \"REDIRECT_URI:\":\"https://beta.booki.me/oauth-callback\"}" > config.json;
    fi
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" == "dev" ]; then
      echo "{\"API_URL:\":\"https://dev-api.booki.me\", \"API_VERSION:\":\"1\", \"CLIENT_ID:\":\"2\", \"REDIRECT_URI:\":\"https://dev.booki.me/oauth-callback\"}" > config.json;
    fi
  - yarn test
script:
  - yarn run build
after_success:
  - echo "";#cd build && zip booki-frontend *
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" == "release" ]; then
      export GIT_TAG=build-release-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
      git config --global user.email "builds@travis-ci.com";
      git config --global user.name "Travis CI";
      echo -n $GIT_TAG > public/version;
      git commit -m "Set build VERSION number" public/version;
      git tag $GIT_TAG -a -m "Generated tag from Travis CI build $TRAVIS_BUILD_NUMBER";
      git push --quiet https://$GITHUBKEY@github.com/hexcodech/booki-frontend $GIT_TAG > /dev/null 2>&1;
    fi
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" == "master" ]; then
      export GIT_TAG=build-staging-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER;
      git config --global user.email "builds@travis-ci.com";
      git config --global user.name "Travis CI";
      git commit -a -m "Built files";
      git push --quiet https://$GITHUBKEY@github.com/hexcodech/booki-frontend > /dev/null 2>&1;
    fi
  - if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" == "dev" ]; then
      export GIT_TAG=build-dev-$TRAVIS_BRANCH-$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER;
      git config --global user.email "builds@travis-ci.com";
      git config --global user.name "Travis CI";
      git commit -a -m "Built files";
      git push --quiet https://$GITHUBKEY@github.com/hexcodech/booki-frontend > /dev/null 2>&1;
    fi
